import{j as e,r,A as E,b as F,u as $}from"./index-CjYO5HdS.js";import{M as B}from"./AddyMine-RVErtJP2.js";import{S as P}from"./SupportFileRenderer-1nsAEcN3.js";import"./useClickOutside-CGyhsngc.js";const R=({communicationLogs:c})=>e.jsx("div",{className:"w-[95%] flex justify-center items-center flex-wrap",children:c.map((a,l)=>{var o;return e.jsx("div",{className:`w-full m-0 p-3 rounded-md ${a.sentBy==="user"?"flex justify-start":"flex justify-end"}`,children:e.jsxs("div",{className:`p-2 rounded-md max-w-[550px] flex-wrap flex justify-start ${a.sentBy==="user"?"text-blue-600 bg-blue-100":"text-[var(--senderchattext)] bg-[var(--senderchatbg)]"} `,children:[e.jsx("p",{className:` flex justify-start  ${a.sentBy==="user"?"text-[var(--recieverchattext)] bg-[var(--recieverchatbg)]":"text-[var(--senderchattext)] bg-[var(--senderchatbg)]"}`,children:a.message}),((o=a.files)==null?void 0:o.length)>0&&e.jsx(P,{data:a.files}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 w-full  text-right",children:new Date(a.sentAt).toLocaleString()})]})},l)})}),_=()=>{const{isLoggedIn:c,getStoredUserObj:a,getStoredToken:l,setPageTitle:o}=r.useContext(E),{API_supportBase_url:g}=r.useContext(B),{ticketID:p}=F(),[h,d]=r.useState(!1),[S,j]=r.useState(!1),[C,k]=r.useState({}),[n,y]=r.useState({}),[u,m]=r.useState(""),[b,f]=r.useState([]),x=r.useRef(),v=$();r.useEffect(()=>{c()||v("/")},[c,v]),r.useEffect(()=>{o("TICKET CHAT(A)"),k(a()),x.current.focus(),T()},[a,o]);const T=async()=>{d(!0);try{const t=`${g}api/a/v1.00/supportticket/${p}`,s=await(await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",authorization:`Bearer ${l()}`}})).json();if(s.status==="success"&&s.data)y(s.data),console.log("data.data",s.data),m(""),f([]);else throw new Error(s.message||"Failed to fetch support tickets.")}catch(t){console.error("Request failed:",t)}finally{d(!1)}},L=t=>{f(Array.from(t.target.files))},w=async()=>{if(!u.trim()&&b.length===0)return;d(!0),j(!0);const t=new FormData;t.append("message",u),t.append("sentBy","agent"),b.forEach(i=>{t.append("files",i)});try{const s=await(await fetch(`${g}api/a/v1.00/supportticket/message/${p}`,{method:"PATCH",headers:{authorization:`Bearer ${l()}`},body:t})).json();if(console.log("result",s),s.status==="success")console.log("result.data",s.data),y(N=>({...N,communicationLogs:[...N.communicationLogs,s.data]})),m(""),f([]),x.current.focus();else throw new Error(s.message||"Failed to send message.")}catch(i){console.error("Failed to send message:",i)}finally{d(!1),j(!1)}},A=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),w())};return e.jsx("section",{className:"flex justify-center items-center mx-6 mb-3",children:e.jsx("div",{className:"cards-container max-w-[850px] flex-wrap w-full justify-center bg-[var(--container-bg-color)] rounded-md",children:e.jsxs("div",{className:"w-full flex justify-center items-center rounded-md flex-wrap",children:[n?e.jsxs(e.Fragment,{children:[e.jsx("div",{role:"button","aria-label":"Open support ticket",className:"w-full flex-grow min-h-7 flex justify-center items-center rounded-md cursor-pointer hover:bg-opacity-90 font-bold",children:n.issueTitle}),e.jsx("div",{className:"bg-[var(--container-bg-color)] flex-grow min-h-16 flex justify-center items-center rounded-md",children:n.category}),e.jsx("div",{className:"bg-[var(--container-bg-color)] flex-grow min-h-16 flex justify-center items-center rounded-md",children:n.priority}),e.jsx("div",{className:"bg-[var(--container-bg-color)] flex-grow min-h-16 flex justify-center items-center rounded-md",children:n.status}),e.jsx("div",{className:"w-full h-[90vh] overflow-y-auto bg-[var(--background-color)] m-1 flex-grow min-h-7 flex justify-center items-start rounded-md cursor-pointer hover:bg-opacity-90",children:n.communicationLogs&&n.communicationLogs.length?e.jsx(R,{userId:C._id,communicationLogs:n.communicationLogs.reverse()}):e.jsx("p",{className:"text-center",children:"No communication logs"})})]}):e.jsx("p",{children:"Loading ticket details..."}),e.jsxs("div",{className:"min-h-0 w-full flex justify-center items-start m-1 p-1 bg-gray-200 rounded-md",children:[e.jsxs("label",{className:"m-0 p-2 h-12 bg-[var(--accent-color)] text-white flex justify-center items-center rounded-md cursor-pointer button",children:["Files",e.jsx("input",{type:"file",multiple:!0,onChange:L,className:"hidden"})]}),e.jsx("textarea",{ref:x,className:"flex-grow h-12 basis-72 m-0 p-2 border text-[var(--secondary-text-color)] rounded-md",value:u,onChange:t=>m(t.target.value),onKeyPress:A,placeholder:"Respond to user",disabled:h}),e.jsx("button",{className:"flex-grow-1 p-2 m-0 h-12 font-bold bg-[var(--accent-color)] text-white rounded-md",onClick:w,disabled:h,children:S?"Sending...":"Send"})]})]})})})};export{_ as default};
